version: "3.9"
services:
  backend:
    build:
      context: .
      dockerfile: backend.Dockerfile
    container_name: backend
    depends_on:
      - cache
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: "0.5"
          memory: 500Mi
        reservations:
          cpus: "0.1"
          memory: 10Mi
      update_config:
        parallelism: 1
    environment:
      CACHE_ENDPOINT: cache:6379
    healthcheck:
      disable: false
      interval: 1m0s
      retries: 3
      start_period: 1m0s
      test: ["CMD","echo","Define healthcheck command for service backend"]
      timeout: 10s
    image: ezodude/backend-cok8s:dev
    networks:
      dev-esnet: null
    ports:
      - mode: ingress
        protocol: tcp
        published: 8008
        target: 8080
  cache:
    container_name: cache
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: "0.5"
          memory: 500Mi
        reservations:
          cpus: "0.1"
          memory: 10Mi
      update_config:
        parallelism: 1
    healthcheck:
      disable: false
      interval: 1m0s
      retries: 3
      start_period: 1m0s
      test: ["CMD","echo","Define healthcheck command for service cache"]
      timeout: 10s
    image: docker.io/bitnami/redis:6.0-debian-10
    networks:
      dev-esnet: null
    ports:
      - mode: ingress
        protocol: tcp
        published: 6379
        target: 6379
    volumes:
      - source: redis_data
        target: /bitnami/redis/data
        type: volume
  frontend:
    build:
      context: .
      dockerfile: frontend.Dockerfile
    container_name: frontend
    depends_on:
      - backend
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: "0.5"
          memory: 500Mi
        reservations:
          cpus: "0.1"
          memory: 10Mi
      update_config:
        parallelism: 1
    environment:
      PORT: 8080
    healthcheck:
      disable: false
      interval: 1m0s
      retries: 3
      start_period: 1m0s
      test: ["CMD","echo","Define healthcheck command for service frontend"]
      timeout: 10s
    image: ezodude/frontend-cok8s:dev
    networks:
      dev-esnet: null
    ports:
      - mode: ingress
        protocol: tcp
        published: 8080
        target: 8080
networks:
  dev-esnet:
    driver: bridge
    name: dev-esnet
volumes:
  redis_data:
    driver: local
    name: redis_data

version: "3.7"
services:
  db:
    command:
      - --default-authentication-plugin=mysql_native_password
    deploy:
      mode: replicated
      replicas: ${db.workload.replicas}
      resources:
        limits:
          cpus: ${db.workload.max-cpu}
          memory: ${db.workload.max-memory}
        reservations:
          cpus: ${db.workload.cpu}
          memory: ${db.workload.memory}
      update_config:
        parallelism: ${db.workload.rolling-update-max-surge}
    healthcheck:
      disable: ${db.workload.liveness-probe-disable}
      interval: ${db.workload.liveness-probe-interval}
      retries: ${db.workload.liveness-probe-retries}
      start_period: ${db.workload.liveness-probe-initial-delay}
      test: ${db.workload.liveness-probe-command}
      timeout: ${db.workload.liveness-probe-timeout}
    image: mysql:8.0.19
    networks:
      default: null
    restart: always
    volumes:
      - source: db_data
        target: /var/lib/mysql
        type: volume
  wordpress:
    deploy:
      mode: replicated
      replicas: ${wordpress.workload.replicas}
      resources:
        limits:
          cpus: ${wordpress.workload.max-cpu}
          memory: ${wordpress.workload.max-memory}
        reservations:
          cpus: ${wordpress.workload.cpu}
          memory: ${wordpress.workload.memory}
      update_config:
        parallelism: ${wordpress.workload.rolling-update-max-surge}
    environment:
      WORDPRESS_DB_HOST: ${wordpress.environment.WORDPRESS_DB_HOST}
      WORDPRESS_DB_NAME: ${wordpress.environment.WORDPRESS_DB_NAME}
      WORDPRESS_DB_PASSWORD: ${wordpress.environment.WORDPRESS_DB_PASSWORD}
      WORDPRESS_DB_USER: ${wordpress.environment.WORDPRESS_DB_USER}
    healthcheck:
      disable: ${wordpress.workload.liveness-probe-disable}
      interval: ${wordpress.workload.liveness-probe-interval}
      retries: ${wordpress.workload.liveness-probe-retries}
      start_period: ${wordpress.workload.liveness-probe-initial-delay}
      test: ${wordpress.workload.liveness-probe-command}
      timeout: ${wordpress.workload.liveness-probe-timeout}
    image: wordpress:latest
    networks:
      default: null
    ports:
      - mode: ingress
        protocol: tcp
        published: 80
        target: 80
    restart: always
networks:
  default:
    name: default
volumes:
  db_data:
    name: db_data
